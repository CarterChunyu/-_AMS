SELECT CASE WHEN g.MERCHANT_STNAME='統一超商' THEN '統一超商(IBON)' ELSE g.MERCHANT_STNAME END AS MERCHANT_STNAME,CONVERT(BIGINT,SUM(CPT_AMT)) AS NET,FEE_RATE,@newRate AS NEW_RATE,CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*FEE_RATE,0)) AS CHARGE,CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*@newRATE,0)) AS NEW_CHARGE,CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*FEE_RATE,0))-CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*@newRATE,0)) AS DIFF,CONVERT(BIGINT,ROUND((CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*FEE_RATE,0))-CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*@newRATE,0)))/1.05,0)) AS UNTAXED,CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*FEE_RATE,0))-CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*@newRATE,0))-CONVERT(BIGINT,ROUND((CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*FEE_RATE,0))-CONVERT(BIGINT,ROUND(SUM(CPT_AMT)*@newRATE,0)))/1.05,0)) AS TAX FROM [{0}].TM_FEESUM_M m
INNER JOIN dbo.GM_MERCHANT g
ON m.MERCHANT_NO=g.MERCHANT_NO 
WHERE SETTLE_TYPE='P' AND  LEFT(CPT_SDATE,6)=@yearMonth GROUP BY MERCHANT_STNAME,LEFT(CPT_SDATE,6),FEE_RATE